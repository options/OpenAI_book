## 4.3 대화형 프롬프트 디자인과 흐름 제어

OpenAI의 Chat Completions API는 단순한 텍스트 완성(Text Completion)을 넘어서, 대화형의 인터페이스를 구성하는 데 최적화된 구조를 가지고 있습니다. 이 절에서는 실질적인 대화형 애플리케이션을 구축하기 위해 필요한 프롬프트 구성 원칙, 턴 기반 대화 흐름 디자인, 컨텍스트 유지 전략, 반복성과 흐름 제어(Turn Management)에 대한 기법을 상세하게 설명합니다.



### 4.3.1 메시지 구조의 이해: System - User - Assistant

Chat Completions API는 대화를 구성하기 위해 다음과 같은 메시지 역할 구조를 사용합니다:

- system: AI의 성격이나 지시사항을 설정  
- user: 실제 사용자 입력  
- assistant: 모델이 이전 턴에서 생성한 응답

이러한 구조는 단순한 Prompt→Response 형태에서 벗어나, "역할 기반(turn-based)" 대화 콘텍스트를 탄탄하게 유지해 줍니다.

📝 예시:

```json
[
  {"role": "system", "content": "당신은 친절한 여행 가이드입니다. 짧고 실용적인 표현만 사용하세요."},
  {"role": "user", "content": "스페인 바르셀로나의 명소 몇 군데 추천해줘."},
  {"role": "assistant", "content": "좋아요! 바르셀로나에서 가볼 만한 명소는 다음과 같아요:\n1. 사그라다 파밀리아\n2. 구엘 공원\n3. 고딕 지구"},
  {"role": "user", "content": "입장료는 얼마야?"}
]
```

이러한 차곡차곡 쌓이는 대화 기록은 GPT가 맥락을 이해하고 적절한 응답을 생성하는 데 결정적인 역할을 합니다.



### 4.3.2 대화 흐름 설계의 기본 원칙

고급 대화형 애플리케이션을 설계하려면 단순한 질의응답을 넘어서 명확한 의도 라우팅과 응답 유지를 위한 전략이 필요합니다.

다음은 대화 흐름 설계 시 핵심 고려 요소들입니다:

| 요소 | 설명 |
|------|------|
| 초기 시스템 설정(system prompt) | 역할, 어조, 응답 형식 등을 정의 |
| 명확한 context 유지 | 메시지를 쌓아가되, 토큰 한도를 고려해 과거 대화를 압축 또는 제거 |
| 유도 질문 형식 활용 | 사용자의 후속 입력을 유도하여 대화 지속 |
| 제약 조건 명기 | 과도한 또는 잘못된 응답 방지 (예: "20자 이하로 설명하세요") |
| 사용자 발화 의도 분기 처리 | 프롬프트 내 명세 또는 함수 호출로 흐름 제어 가능 |



### 4.3.3 시나리오 기반 프롬프트 디자인

다양한 시나리오에 따라 대화 흐름을 어떻게 설계할 수 있을지 예제를 통해 실전적인 접근 방식을 설명합니다.

🧭 예제 시나리오: 고객 상담 챗봇

1. 상황: 고객이 제품 문의를 함
2. 요구사항: 제품 목록을 보여주고, 고객의 선택에 따라 상세 정보를 제공

프롬프트 구성:

```python
messages = [
  {"role": "system", "content": "당신은 전자제품 쇼핑몰의 유능한 고객 상담 챗봇입니다. 사용자의 질문에 명확하고 친절하게 안내하세요."},
  {"role": "user", "content": "어떤 노트북이 있나요?"},
]
```

응답 예시:

```
현재 저희 쇼핑몰에서 인기 있는 노트북은 다음과 같습니다:
1. MacBook Air M2
2. Samsung Galaxy Book3
3. LG Gram 2023
원하시는 제품 번호를 입력해 주세요!
```

사용자가 "2번"이라고 응답하면, 뒤이어 다음과 같이 세분화된 흐름으로 이어갑니다.

```python
messages.append({"role": "assistant", "content": 위 응답})
messages.append({"role": "user", "content": "2번이요"})
```

이러한 전개는 규칙 기반 대화 흐름 분기 처리와 비슷하게 설계할 수 있습니다. 복잡해질 경우, Function Calling 기능과 연동하여 보다 정교한 흐름을 구성할 수 있습니다 (7장에서 자세히 다룸).



### 4.3.4 대화의 상태 관리와 컨텍스트 유지 전략

대화형 프롬프트는 상태(State) 유지가 중요합니다. 그러나 OpenAI API는 상태 저장 기능이 없으므로, 이를 애플리케이션 코드에서 관리해야 합니다:

- 전체 메시지 히스토리를 메시지 배열로 유지
- 토큰 한도를 고려한 메시지 요약 또는 압축
- 메모리(Database, Redis 등)에 사용자 ID별 메시지 기록 저장 구조 설계

💡 실전 팁:

- max_tokens와 함께 대화 길이가 늘어나면 오래된 메시지를 제거하거나 요약본으로 대체
- 예시로 “이전 대화 내용을 요약한 system 메시지” 삽입:

```python
{"role": "system", "content": "지금까지의 대화 요약: 고객은 삼성 노트북에 관심이 있으며 가격, 사양, AS 조건을 문의함"}
```

이 방식은 context window를 효율적으로 줄이면서도 맥락을 유지할 수 있습니다.



### 4.3.5 토큰 한도와 대화 압축 전략

모델 별 토큰 한도는 다음과 같습니다 (2024년 기준):

| 모델 | 최대 context token |
|------|--------------------|
| gpt-3.5-turbo | 16,385 tokens |
| gpt-4-turbo | 128,000 tokens |
| gpt-4o | 128,000 tokens |

한도를 초과하면 에러가 발생하거나 맥락이 잘릴 수 있습니다.

실전 대응 방법:

- 불필요한 메시지는 삭제
- assistant 응답을 원본 → 요약으로 교체
- 이전 메시지를 Embedding으로 벡터화 후 유사 메시지만 컨텍스트에 포함 (6장에서 자세히 설명)



### 4.3.6 사용자 반응에 따른 동적 흐름 전환

사용자는 언제든 대화의 흐름을 바꿀 수 있습니다. GPT 모델은 대화형 구조이지만, 대화 흐름 관리자가 아니기 때문에 의도 파악과 라우팅은 개발자 혹은 프론트엔드에서 선별해야 할 필요가 있습니다.

예:

- 사용자 A: "아, 됐고 요즘 날씨나 알려줘."
- 사용자 B: "다시 처음부터 설명해줘."

이런 전환 입력을 감지할 수 있도록 다음과 같은 기법 활용:

- 프롬프트에 "사용자가 주제를 바꾸는 경우, 친절하게 새 주제로 전환하세요." 명시
- Embedding을 활용하여 입력 분류 (정보요청 vs 잡담 vs 클로징 등)
- 선택지 제공 형식의 assistant 응답 구성

🗣 상호작용 예시:

```
다른 정보를 원하시나요? 다음 중 선택해 주세요:  
1. 다른 노트북 제품 보기  
2. 배송 및 반품 안내  
3. 상담 종료
```



### 4.3.7 흐름 제어 예시: Q&A 봇 구성 흐름도

다음은 질문-응답 기반 챗봇을 설계할 때의 흐름 예시입니다.

```text
[시작]
  ↓ system 프롬프트 설정
  ↓ 사용자 입력 (질문)
  ↓ GPT 응답 생성
  └→ 응답 후 선택지 유도 포함 → [선택 입력 → 루프]
       └→ 주제 벗어난 입력 → [Context reset or 전환 감지]
```

효과적인 프롬프트 디자인은 단순한 응답 생성에 그치지 않고 사용자 경험(UX)을 자연스럽게 유도하는 데 그 목적이 있습니다.



### 4.3.8 대화 실패 및 예외 상황 처리

대화형 챗봇을 만들다 보면 예상하지 못한 입력, 무의미한 질문, 반복성 응답 등의 문제가 발생할 수 있습니다.

예외 처리 방법:

- “이해하지 못했어요” 식의 응답은 피하고 재질문 유도
- 과도한 길이의 입력 처리 제한 → 시스템 프롬프트에 조건 삽입
- 반복 질문에 대해서는 context 기반 반복감소 유도

```python
{"role": "system", "content": "동일한 질문에 대해서는 같은 답변을 반복하지 말고, 예시나 새로운 정보를 추가로 보태 주세요."}
```



### 4.3.9 정리: 챗봇 설계자를 위한 베스트 프랙티스

- 시스템 지시문은 항상 구체적으로 작성하라
- 대화 흐름은 스크립트 기반보다는 turn-based 구조로 구성하라
- 사용자 행동을 예측하고 미리 응답 설계하라
- 흐름 전환을 감지하고 context 전환점을 명확히 하라
- 메시지 저장 구조와 요약 전략을 통해 context overload를 방지하라



▶️ 다음 장에서는 이러한 대화형 프롬프트를 보다 효과적으로 작성하기 위한 프롬프트 엔지니어링의 심화 기법(Zero-shot, Few-shot, 오류 방지 등)을 탐구합니다.